<%= form_with model: post, local: true, id: "form" do |f| %>
  <%= render 'layouts/error_messages', obj: post %>
  <div class="row">
    <div class="col-lg-3 mb-3">
      <label for="prefecture" class="form-label">投稿する都道府県名</label>
      <%= f.select :prefecture, User.prefecture_methods.map {|k| [k[0], k[1]]}, {}, class: "form-select", id: "prefecture" %>
    </div>
    <div class="col-lg-3 mb-3">
      <label for="city" class="form-label">投稿する市区町村名</label>
      <%= f.text_field :city, placeholder: "○○市○○区", class: "form-control", id: "city" %>
    </div>
    <div class="col-lg-3 mb-3">
      <label for="landmark" class="form-label">近くの目印になる建物</label>
      <%= f.text_field :landmark, placeholder: "スーパーやバス停など", class: "form-control", id: "landmark" %>
    </div>
    <div class="col-lg-3 mb-3">
      <label for="snow_image" class="form-label">積もり具合が分かる写真</label>
      <%= f.file_field :snow_image, class: "form-control", accept: 'image/*', id:"snow_image" %>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-3 mb-3">
      <label for="sidewalk" class="form-label">歩道のようす</label>
      <div class="form-check text-wrap", style="width: 18rem;">
        <%= f.collection_radio_buttons :sidewalk, Post.sidewalk_methods.to_a, :second, :first %>
      </div>
    </div>
    <div class="col-lg-3 mb-3">
      <label for="snow_height" class="form-label">積雪の高さ</label>
      <div class="form-check", style="width: 10rem;">
        <%= f.collection_radio_buttons :snow_height, Post.snow_height_methods.to_a, :second, :first %>
      </div>
    </div>
    <div class="col-lg-3 mb-3">
      <label for="snow_state" class="form-label">雪のようす</label>
      <div class="form-check", style="width: 10rem;">
        <%= f.collection_radio_buttons :snow_state, Post.snow_state_methods.to_a, :second, :first %>
      </div>
    </div>
  </div>
  <div class="mb-3">
    <label for="message" class="form-label">メッセージ(70字以内)</label>
    <%= f.text_area :message, placeholder: "メッセージやアドバイスなどご自由にどうぞ", class: "form-control", id: "message" %>
  </div>

  <div class="row mb-3">
    <label for="map" class="form-label">位置情報の登録（任意）</label>
    <div class="input-group">
      <%= button_tag "現在位置取得", id: "btn", type: 'button', onclick: "codeAddress()", class: "btn btn-outline-primary me-2" %>
      <input id="address" type="textbox" placeholder="地名や建物の名前など" class="form-control">
      <%= button_tag "検索", type: 'button', onclick: "codeAddress()", class: "btn btn-outline-secondary" %>
    </div>
    <div id='map'></div>
  </div>
  <input id="latitude" value=<%= f.hidden_field :latitude %>
  <input id="longitude" value=<%= f.hidden_field :longitude %>
  <button type="submit" form= "form" class="btn btn-primary"><i class="fa-solid fa-paper-plane"></i> 投稿する</button>
<% end %>

<style>
  #map{
    height: 100px;
  }
</style>

<script>
  let map
  let geocoder
  let marker = null
  // 基準地（東京都）の緯度経度
  let lat = 35.6894
  let lng = 139.6917

  function initMap(){
    // geocoderの初期化
    geocoder = new google.maps.Geocoder()
    // インスタンスの作成
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 15,
      center: {lat: lat, lng: lng}
    });
    //初期マーカー
    marker = new google.maps.Marker({
      map: map,
      position: new google.maps.LatLng(lat, lng),
    });
    document.getElementById("latitude").value = lat;
    document.getElementById("longitude").value = lng;
    //マーカークリック時のイベント
    map.addListener('click', function(e) {
      dragMap(e.latLng, map);
    });
  }

  // 現在位置取得ボタンを押した時の処理
  document.getElementById("btn").onclick = function(){
    navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
  };
  // 取得に成功した場合の処理
  function successCallback(position){
    lat = position.coords.latitude;
    lng = position.coords.longitude;
    document.getElementById("latitude").value = lat;
    document.getElementById("longitude").value = lng;
    map.setCenter(
      new google.maps.LatLng(lat, lng)
    );
    marker.setMap(null);
    marker = new google.maps.Marker({
      map: map,
      position: new google.maps.LatLng(lat, lng)
    });
  };
  // 取得に失敗した場合の処理
  function errorCallback(error){
      alert("位置情報が取得できませんでした");
  };

  // 検索窓で検索した場合の処理
  function codeAddress(){
    const inputAddress = document.getElementById('address').value;
    geocoder.geocode( {'address': inputAddress}, function(results, status) {
      if (status == 'OK') {
        let location = results[0].geometry.location;
        lat = location.lat();
        lng = location.lng();
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
        map.setCenter(location);
        marker = new google.maps.Marker({
          map: map,
          position: location
        });
      } else {
        alert('該当する結果がありませんでした：' + status);
      }
    });
  }

  // ピンの位置を修正した場合の処理
  function dragMap(geo, map) {
    lat = geo.lat();
    lng = geo.lng();
    document.getElementById("latitude").value = lat;
    document.getElementById("longitude").value = lng;
    //中心にスクロール
    map.setCenter(geo);
    //マーカーの更新
    marker.setMap(null);
    marker = null;
    marker = new google.maps.Marker({
      map: map,
      position: geo
    });
  }
</script>